name: Build Native Libraries

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to Maven Central after build'
        required: false
        type: boolean
        default: false
      version_tag:
        description: 'Version tag for release (e.g., v0.1.0)'
        required: false
        type: string

env:
  JAI_MACOS_X64_URL: ${{ vars.JAI_MACOS_X64_URL }}
  JAI_MACOS_ARM64_URL: ${{ vars.JAI_MACOS_ARM64_URL }}
  JAI_WINDOWS_URL: ${{ vars.JAI_WINDOWS_URL }}

jobs:
  # =============================================================================
  # Linux Build (x86_64)
  # =============================================================================
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: 446385817927.dkr.ecr.ap-southeast-2.amazonaws.com/jai:latest
      credentials:
        username: AWS
        password: ${{ secrets.AWS_ECR_PASSWORD }}

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git libx11-dev openjdk-11-jdk-headless

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Jai shared library
        working-directory: jai-system-hotkey
        run: jai build_shared.jai

      - name: Copy Jai library and build JNI
        run: |
          make jai
          make jni

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-linux-x86_64
          path: src/main/resources/natives/linux-x86_64/
          retention-days: 1

  # =============================================================================
  # macOS Build (x86_64 and arm64)
  # =============================================================================
  build-macos-x64:
    runs-on: macos-13  # x86_64 runner
    needs: build-linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download and setup Jai
        run: |
          curl -L -o jai.tar.gz "$JAI_MACOS_X64_URL"
          mkdir -p $HOME/jai
          tar -xzf jai.tar.gz -C $HOME/jai --strip-components=1
          echo "$HOME/jai" >> $GITHUB_PATH

      - name: Build Jai shared library
        working-directory: jai-system-hotkey
        run: jai build_shared.jai

      - name: Copy Jai library and build JNI
        run: |
          make jai
          make jni

      - name: Upload macOS x64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-macos-x86_64
          path: src/main/resources/natives/macos-x86_64/
          retention-days: 1

  build-macos-arm64:
    runs-on: macos-14  # arm64 runner
    needs: build-linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download and setup Jai
        run: |
          curl -L -o jai.tar.gz "$JAI_MACOS_ARM64_URL"
          mkdir -p $HOME/jai
          tar -xzf jai.tar.gz -C $HOME/jai --strip-components=1
          echo "$HOME/jai" >> $GITHUB_PATH

      - name: Build Jai shared library
        working-directory: jai-system-hotkey
        run: jai build_shared.jai

      - name: Copy Jai library and build JNI
        run: |
          make jai
          make jni

      - name: Upload macOS arm64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-macos-aarch64
          path: src/main/resources/natives/macos-aarch64/
          retention-days: 1

  # =============================================================================
  # Windows Build (x86_64)
  # =============================================================================
  build-windows:
    runs-on: windows-latest
    needs: build-linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download and setup Jai
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri $env:JAI_WINDOWS_URL -OutFile jai.zip
          Expand-Archive -Path jai.zip -DestinationPath $env:USERPROFILE\jai
          echo "$env:USERPROFILE\jai" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build Jai shared library
        shell: cmd
        working-directory: jai-system-hotkey
        run: jai build_shared.jai

      - name: Build JNI library
        shell: bash
        run: |
          mkdir -p src/main/resources/natives/windows-x86_64
          cp jai-system-hotkey/lib/system_hotkey.dll src/main/resources/natives/windows-x86_64/

          # Build JNI wrapper
          gcc -shared -o src/main/resources/natives/windows-x86_64/system_hotkey_jni.dll \
            -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/win32" \
            -Isrc/main/resources/natives/windows-x86_64 \
            src/main/c/system_hotkey_jni.c \
            -Lsrc/main/resources/natives/windows-x86_64 -lsystem_hotkey

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: natives-windows-x86_64
          path: src/main/resources/natives/windows-x86_64/
          retention-days: 1

  # =============================================================================
  # Commit all native libraries
  # =============================================================================
  commit-natives:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-x64, build-macos-arm64, build-windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Copy artifacts to natives directory
        run: |
          mkdir -p src/main/resources/natives
          cp -r artifacts/natives-linux-x86_64 src/main/resources/natives/linux-x86_64
          cp -r artifacts/natives-macos-x86_64 src/main/resources/natives/macos-x86_64
          cp -r artifacts/natives-macos-aarch64 src/main/resources/natives/macos-aarch64
          cp -r artifacts/natives-windows-x86_64 src/main/resources/natives/windows-x86_64

      - name: Commit native libraries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/main/resources/natives/
          git diff --staged --quiet || git commit -m "Update native libraries for all platforms

          Built by GitHub Actions workflow run #${{ github.run_number }}"
          git push

  # =============================================================================
  # Tag and Publish to Maven Central (optional)
  # =============================================================================
  publish:
    runs-on: ubuntu-latest
    needs: commit-natives
    if: ${{ inputs.publish == true }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Create and push tag
        if: ${{ inputs.version_tag != '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ inputs.version_tag }}" -m "Release ${{ inputs.version_tag }}"
          git push origin "${{ inputs.version_tag }}"

      - name: Build and publish to Maven Central
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mvn clean deploy -P release -B
